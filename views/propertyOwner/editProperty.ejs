<!DOCTYPE html>
<html>
<head>
  <title>Edit Property</title>
  <link rel="stylesheet" href="/css/adminDashboard.css" />
  <style>
   /* Move to external CSS for better maintenance */
   h2 {
      text-align: center;
    }
    body {
      display: flex;
      flex-direction: column;
      margin-bottom: 20px;
    }
    .edit-property-form {
      max-width: 600px;
      margin: auto;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
    }
    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
    }
    .form-group button {
      display: block;
      margin: auto;
      padding: 10px 20px;
    }
    .image-preview {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }
    .image-preview img {
      max-width: 100px;
      max-height: 100px;
      display: block;
    }
    .image-preview .image-container {
      position: relative;
    }
    .image-preview .remove-btn {
      position: absolute;
      top: 0;
      right: 0;
      background: red;
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
    }
    .img-src {
      width: 50px;
      height: 50px;
      padding: 5px 5px;
    }
    .room-fac {
        position: absolute;
      display: -ms-inline-grid;
    }
    .form-group button {
      display: block;
      margin: auto;
      padding: 1px 5px;
    }
  </style>
</head>
<body>
    <main>
        <h2>Edit Property</h2>
        <% if (messages.error) { %>
          <div class="flash-error"><%= messages.error %></div>
        <% } %>
        <% if (messages.success) { %>
          <div class="flash-success"><%= messages.success %></div>
        <% } %>
        <form class="edit-property-form" action="/owner/dashboard/editProperty/<%= property._id %>" method="POST" enctype="multipart/form-data">
          <div class="form-group">
            <label for="propertyName">Property Name:</label>
            <input type="text" id="propertyName" name="propertyName" value="<%= property.propertyName %>" required />
          </div>
          <div class="form-group">
            <label for="categoryName">Category Name:</label>
            <select id="categoryName" name="categoryName" required>
              <% categories.forEach(category => { %>
                <option  name="categoryName" value="<%= category.name %>" <%= property.categoryName === category.name ? 'selected' : '' %>><%= category.name %></option>
              <% }); %>
            </select>
          </div>
          <div class="form-group">
            <label for="roomFacilities">Room Facilities:</label><br>
            <% roomFacilities.forEach(facility => { %>
              <input class="room-fac" type="checkbox" id="<%= facility %>" name="roomFacilities[]" value="<%= facility %>" <%= property.roomFacilities.includes(facility) ? 'checked' : '' %>>
              <label class="room-fac" name="roomFacilities[]" for="<%= facility %>"><%= facility %></label><br>
            <% }); %>
          </div>
          <div class="form-group">
            <label for="description">Description:</label>
            <textarea id="description" name="description" required><%= property.description %></textarea>
          </div>
          <div class="form-group">
            <label for="address">Address:</label>
            <input type="text" id="address" name="address" value="<%= property.address %>" required />
          </div>
          <div class="image-preview" id="imagePreview">
        <% property.images.forEach((image, index) => { %>
          <div class="image-container">
            <img class="img-src" src="/img/assets/<%= image %>" alt="Property Image" />
            <button type="button" class="remove-btn" onclick="removeExistingImage(this, '<%= image %>')">&times;</button>
            <input type="hidden" name="existingImages[]" value="<%= image %>">
          </div>
        <% }) %>
      </div>

      <!-- New image upload field -->
      <div class="form-group">
        <label for="images">New Images:</label>
        <input type="file" id="images" name="images" multiple accept="image/*" onchange="previewImages()" />
        <input type="button" id="fileCountDisplay" value="Choose Files" onclick="document.getElementById('images').click();" />
      </div>
          <button type="submit">Save Changes</button>
        </form>
      </main>
    
      <script>
        function previewImages() {
          const imagePreview = document.getElementById('imagePreview');
          const files = document.getElementById('images').files;
          const fileCountDisplay = document.getElementById('fileCountDisplay');
          fileCountDisplay.value = files.length ? `${files.length} files` : 'Choose Files';
    
          for (let i = 0; i < files.length; i++) {
            const reader = new FileReader();
            reader.onload = function(e) {
              const imageContainer = document.createElement('div');
              imageContainer.classList.add('image-container');
              const img = document.createElement('img');
              img.src = e.target.result;
              img.alt = 'Property Image';
              imageContainer.appendChild(img);
              const removeButton = document.createElement('button');
              removeButton.type = 'button';
              removeButton.classList.add('remove-btn');
              removeButton.innerHTML = '&times;';
              removeButton.onclick = function() {
                imagePreview.removeChild(imageContainer);
                updateFileCount();
              };
              imageContainer.appendChild(removeButton);
              imagePreview.appendChild(imageContainer);
            };
            reader.readAsDataURL(files[i]);
          }
        }
    
        function updateFileCount() {
          const files = document.getElementById('images').files;
          document.getElementById('fileCountDisplay').value = files.length ? `${files.length} files` : 'Choose Files';
        }
    
        function removeExistingImage(button, imageName) {
          button.parentElement.remove();
          updateFileCount();
          fetch('/remove-image', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ propertyId: '<%= property._id %>', imageName }),
          })
          .then(response => {
            if (!response.ok) throw new Error('Failed to remove image from the database');
            console.log('Image removed from the database');
          })
          .catch(error => console.error('Error:', error));
        }
      </script>
    </body>
    </html>